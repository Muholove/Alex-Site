<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #1a1a1a;
            color: #fff;
        }
        
        .container {
            width: 100%;
            min-height: 100vh;
        }
        
        .header {
            background-color: #222;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            background-color: #ff0000;
            padding: 5px 15px;
            border-radius: 4px;
        }
        
        .nav {
            display: flex;
            gap: 20px;
        }
        
        .nav a {
            color: #fff;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav a:hover {
            background-color: #333;
        }
        
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: #888;
            position: relative;
        }
        
        .tab.active {
            color: #ff0000;
            border-bottom: 3px solid #ff0000;
        }
        
        .tab i {
            margin-right: 8px;
        }
        
        .tab-content {
            display: none;
            background-color: #222;
            padding: 20px;
            border-radius: 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn {
            background-color: #ff0000;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background-color: #cc0000;
        }
        
        .video-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .video-table th {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            color: #ccc;
        }
        
        .video-table td {
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #ff0000;
            cursor: pointer;
            font-size: 18px;
            margin: 0 5px;
        }
        
        .form-container {
            background-color: #222;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #ff0000;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .upload-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #333;
            color: #fff;
            border: 1px dashed #666;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .upload-btn:hover {
            background-color: #444;
        }
        
        .upload-btn i {
            margin-right: 8px;
            color: #ff0000;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background-color: #222;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
        }
        
        .hidden {
            display: none;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background-color: #28a745;
            color: white;
        }
        
        .status-inactive {
            background-color: #dc3545;
            color: white;
        }
        
        .preview-image {
            max-width: 100px;
            max-height: 60px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #222;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #upload-progress {
            margin: 20px 0;
            padding: 15px;
            background-color: #333;
            border-radius: 5px;
        }
        
        #progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div class="login-header">
                <div class="logo">FreakLeaks</div>
                <h2>Admin Login</h2>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter admin password">
            </div>
            <button id="login-btn" class="btn login-btn">Login</button>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="admin-panel" class="container">
        <div class="header">
            <div class="logo">FreakLeaks</div>
            <div class="nav">
                <a href="#" id="home-link"><i class="fas fa-home"></i> Home</a>
                <a href="#" id="videos-link"><i class="fas fa-video"></i> Videos</a>
                <a href="#" id="admin-link"><i class="fas fa-user"></i> Admin</a>
                <a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <div class="tab active" data-tab="manage-videos">
                    <i class="fas fa-film"></i> Manage Videos
                </div>
                <div class="tab" data-tab="media-files">
                    <i class="fas fa-photo-video"></i> Media Files
                </div>
                <div class="tab" data-tab="site-config">
                    <i class="fas fa-cog"></i> Site Configuration & Users
                </div>
            </div>

            <!-- Dashboard Stats -->
            <div class="form-container" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div style="background-color: #333; padding: 15px; border-radius: 5px; text-align: center;">
                        <i class="fas fa-film" style="font-size: 24px; color: #ff0000; margin-bottom: 10px;"></i>
                        <h3 style="margin: 0; font-size: 28px;" id="total-videos">0</h3>
                        <p style="margin: 5px 0 0; color: #aaa;">Total Videos</p>
                    </div>
                    <div style="background-color: #333; padding: 15px; border-radius: 5px; text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 24px; color: #28a745; margin-bottom: 10px;"></i>
                        <h3 style="margin: 0; font-size: 28px;" id="active-videos">0</h3>
                        <p style="margin: 5px 0 0; color: #aaa;">Active Videos</p>
                    </div>
                    <div style="background-color: #333; padding: 15px; border-radius: 5px; text-align: center;">
                        <i class="fas fa-image" style="font-size: 24px; color: #17a2b8; margin-bottom: 10px;"></i>
                        <h3 style="margin: 0; font-size: 28px;" id="total-images">0</h3>
                        <p style="margin: 5px 0 0; color: #aaa;">Total Images</p>
                    </div>
                    <div style="background-color: #333; padding: 15px; border-radius: 5px; text-align: center;">
                        <i class="fas fa-video" style="font-size: 24px; color: #ffc107; margin-bottom: 10px;"></i>
                        <h3 style="margin: 0; font-size: 28px;" id="total-media-videos">0</h3>
                        <p style="margin: 5px 0 0; color: #aaa;">Media Videos</p>
                    </div>
                </div>
            </div>

            <!-- Manage Videos Tab -->
            <div id="manage-videos" class="tab-content active">
                <div class="section-header">
                    <h2>Manage Videos</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="reload-videos-btn" class="btn" style="background-color: #444;">
                            <i class="fas fa-sync-alt"></i> Reload Videos
                        </button>
                        <button id="view-json-btn" class="btn" style="background-color: #555;">
                            <i class="fas fa-code"></i> View JSON
                        </button>
                        <button id="toggle-form-btn" class="btn">
                            <i class="fas fa-plus"></i> Upload New Video
                        </button>
                    </div>
                </div>

                <!-- Videos Table -->
                <table class="video-table">
                    <thead>
                        <tr>
                            <th>Thumbnail</th>
                            <th>Title</th>
                            <th>Price</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="videos-list">
                        <!-- Videos will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Media Files Tab -->
            <div id="media-files" class="tab-content">
                <div class="section-header">
                    <h2>Media Files</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="scan-media-btn" class="btn" style="background-color: #444;">
                            <i class="fas fa-sync-alt"></i> Scan Media Folders
                        </button>
                        <button id="upload-media-btn" class="btn">
                            <i class="fas fa-upload"></i> Upload Media
                        </button>
                    </div>
                </div>
                
                <!-- Upload Media Form -->
                <div id="upload-media-form" class="form-container" style="display: none; margin-bottom: 20px;">
                    <h3>Upload Media Files</h3>
                    <form id="media-upload-form">
                        <div class="form-group">
                            <label>Select Media Type</label>
                            <select id="media-type" class="form-control">
                                <option value="images">Image (Thumbnail)</option>
                                <option value="videos">Video</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Select File</label>
                            <label for="media-file" class="upload-btn">
                                <i class="fas fa-cloud-upload-alt"></i> Choose File
                            </label>
                            <input type="file" id="media-file" class="file-input">
                            <div id="media-file-name" style="margin-top: 10px; font-size: 14px;"></div>
                        </div>
                        
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Upload File
                        </button>
                    </form>
                </div>
                
                <div class="form-container">
                    <h3>Images (thumbnails)</h3>
                    <div id="images-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div class="loading-message">Loading images...</div>
                    </div>
                    
                    <h3>Videos</h3>
                    <div id="videos-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        <div class="loading-message">Loading videos...</div>
                    </div>
                </div>
            </div>

            <!-- Site Configuration Tab -->
            <div id="site-config" class="tab-content">
                <h2>Site Configuration</h2>
                <div class="form-container">
                    <div class="form-group">
                        <label for="site-title">Site Title</label>
                        <input type="text" id="site-title" class="form-control" value="ADULTFLIX">
                    </div>
                    
                    <div class="form-group">
                        <label for="admin-password">Admin Password</label>
                        <input type="password" id="admin-password" class="form-control" placeholder="Enter new password">
                    </div>
                    
                    <div class="form-group">
                        <label for="paypal-client-id">PayPal Client ID</label>
                        <input type="text" id="paypal-client-id" class="form-control" placeholder="Enter PayPal Client ID">
                    </div>
                    
                    <div class="form-group">
                        <label for="telegram-link">Telegram Support Link</label>
                        <input type="text" id="telegram-link" class="form-control" value="https://t.me/SUPORT_FOLDER">
                    </div>
                    
                    <div class="form-group">
                        <label for="telegram-username">Telegram Username</label>
                        <input type="text" id="telegram-username" class="form-control" placeholder="Enter Telegram Username">
                    </div>
                    
                    <button id="save-config" class="btn">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Deletion</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Are you sure you want to delete this video? This action cannot be undone.</p>
            <div class="modal-footer">
                <button class="btn" style="background-color: #666;">Cancel</button>
                <button id="confirm-delete" class="btn" style="background-color: #dc3545;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Video Details Modal -->
    <div id="video-details-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Video Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="video-details-content" style="margin-top: 20px;">
                <!-- Video details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn close-modal-btn">Close</button>
                <button id="edit-from-details" class="btn" style="background-color: #17a2b8;">Edit</button>
            </div>
        </div>
    </div>

    <!-- Video Upload Modal -->
    <div id="video-upload-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-form-title">Upload New Video</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <input type="hidden" id="video-id" name="video-id">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="price">Price *</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 10px; top: 10px;">$</span>
                            <input type="number" id="price" name="price" class="form-control" style="padding-left: 25px;" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description *</label>
                        <textarea id="description" name="description" class="form-control" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="duration">Duration</label>
                        <input type="text" id="duration" name="duration" class="form-control" placeholder="00:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status" class="form-control">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="video-link">Video Link (for customer after payment) *</label>
                        <input type="text" id="video-link" name="video-link" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Thumbnail Image *</label>
                        <label for="thumbnail-upload" class="upload-btn">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Thumbnail
                        </label>
                        <input type="file" id="thumbnail-upload" name="thumbnail-upload" class="file-input" accept="image/*">
                        <div id="thumbnail-preview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Preview Video</label>
                        <label for="video-upload" class="upload-btn">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Preview Video
                        </label>
                        <input type="file" id="video-upload" name="video-upload" class="file-input" accept="video/*">
                        <div id="video-preview"></div>
                    </div>

                    <!-- Progress Bar -->
                    <div id="upload-progress" style="display: none; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Upload Progress</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <div style="background-color: #333; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div id="progress-bar" style="width: 0%; height: 100%; background-color: #ff0000; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn close-modal-btn" style="background-color: #666;">Cancel</button>
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Save Video
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Function to update dashboard stats
        function updateDashboardStats() {
            // Get video stats
            fetch('videos.json')
                .then(response => {
                    if (!response.ok) {
                        return [];
                    }
                    return response.json();
                })
                .then(videos => {
                    if (!Array.isArray(videos)) {
                        videos = [];
                    }
                    
                    // Update video stats
                    document.getElementById('total-videos').textContent = videos.length;
                    
                    // Count active videos
                    const activeVideos = videos.filter(video => video.status === 'Active').length;
                    document.getElementById('active-videos').textContent = activeVideos;
                })
                .catch(error => {
                    console.error('Error loading video stats:', error);
                });
            
            // Get media stats
            fetch('scan_media.php')
                .then(response => response.json())
                .then(data => {
                    // Update image stats
                    document.getElementById('total-images').textContent = data.images ? data.images.length : 0;
                    
                    // Update media video stats
                    document.getElementById('total-media-videos').textContent = data.videos ? data.videos.length : 0;
                })
                .catch(error => {
                    console.error('Error loading media stats:', error);
                });
        }

        // Function to load configuration
        function loadConfig() {
            fetch('save_config.php')
                .then(response => response.json())
                .then(config => {
                    // Fill in form fields with config values
                    document.getElementById('site-title').value = config.siteTitle || '';
                    document.getElementById('telegram-link').value = config.telegramLink || '';
                    document.getElementById('paypal-client-id').value = config.paypalClientId || '';
                    document.getElementById('telegram-username').value = config.telegramUsername || '';
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                });
        }

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (!isLoggedIn) {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            } else {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadVideos().catch(error => {
                    console.error('Error loading videos on startup:', error);
                });
                updateDashboardStats();
                
                // Load configuration
                loadConfig();
                
                // Set up periodic stats update (every 60 seconds)
                setInterval(updateDashboardStats, 60000);
            }
        });

        // Login functionality
        document.getElementById('login-btn').addEventListener('click', function() {
            const password = document.getElementById('password').value;
            // Simple password check - in production, use server-side validation
            if (password === 'admin123') {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadVideos();
            } else {
                alert('Invalid password. Please try again.');
            }
        });

        // Logout functionality
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('adminLoggedIn');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show selected tab content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Modify the toggle form button click handler
        document.getElementById('toggle-form-btn').addEventListener('click', function() {
            const modal = document.getElementById('video-upload-modal');
            modal.style.display = 'flex';
            document.getElementById('modal-form-title').textContent = 'Upload New Video';
            
            // Reset form and clear hidden ID field to ensure we're creating a new video
                document.getElementById('upload-form').reset();
                document.getElementById('video-id').value = '';
            console.log('Cleared video-id for new video');
            
                document.getElementById('thumbnail-preview').innerHTML = '';
                document.getElementById('video-preview').innerHTML = '';
            document.getElementById('upload-progress').style.display = 'none';
        });

        // File upload preview for thumbnail
        document.getElementById('thumbnail-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('thumbnail-preview').innerHTML = `
                        <img src="${event.target.result}" class="preview-image" alt="Thumbnail Preview">
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        // File upload preview for video
        document.getElementById('video-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    
                    video.onloadedmetadata = function() {
                        // Set the duration in the input field
                        document.getElementById('duration').value = formatDuration(video.duration);
                        
                        // Show video preview
                    document.getElementById('video-preview').innerHTML = `
                        <video width="200" controls>
                            <source src="${event.target.result}" type="${file.type}">
                            Your browser does not support the video tag.
                        </video>
                    `;
                    };
                    
                    video.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submission
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate required fields
            const title = document.getElementById('title').value.trim();
            const price = document.getElementById('price').value.trim();
            const description = document.getElementById('description').value.trim();
            const videoLink = document.getElementById('video-link').value.trim();
            const videoId = document.getElementById('video-id').value.trim();
            
            if (!title || !price || !description || !videoLink) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Show progress bar
            document.getElementById('upload-progress').style.display = 'block';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-percentage').textContent = '0%';
            
            console.log('Creating FormData from form...');
            const formData = new FormData(this);
            
            // Explicitly logging the video-id to debug
            console.log('Video ID being submitted:', videoId);
            console.log('Video ID field value:', document.getElementById('video-id').value);
            
            // Force add the video-id if it exists
            if (videoId) {
                // Remove any existing video-id first to avoid duplicates
                if (formData.has('video-id')) {
                    formData.delete('video-id');
                }
                formData.append('video-id', videoId);
            }
            
            // Check if we have the fields
            console.log('Form elements:');
            for (const [key, value] of formData.entries()) {
                console.log(`${key}: ${value instanceof File ? value.name : value}`);
            }
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    document.getElementById('progress-bar').style.width = percentComplete + '%';
                    document.getElementById('progress-percentage').textContent = Math.round(percentComplete) + '%';
                    console.log(`Upload progress: ${Math.round(percentComplete)}%`);
                }
            });
            
            xhr.addEventListener('load', function() {
                console.log('Server response status:', xhr.status);
                console.log('Server response text:', xhr.responseText);
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            console.log('Video saved successfully!');
                            alert('Video saved successfully!');
                            document.getElementById('video-upload-modal').style.display = 'none';
                            // Reload videos and update stats
                            const cacheBuster = new Date().getTime();
                            fetch('videos.json?_=' + cacheBuster, { 
                                cache: 'no-store',
                                headers: { 'Cache-Control': 'no-cache' }
                            })
                            .then(() => loadVideos())
                            .then(() => updateDashboardStats());
                } else {
                            console.error('Error saving video:', response.message);
                            alert('Error: ' + response.message);
                        }
                    } catch (e) {
                        console.error('Error parsing server response:', e);
                        console.error('Server response:', xhr.responseText);
                        alert('Error processing server response');
                    }
                } else {
                    console.error('Server error status:', xhr.status);
                    console.error('Server response:', xhr.responseText);
                    alert('Error uploading video');
                }
                document.getElementById('upload-progress').style.display = 'none';
            });
            
            xhr.addEventListener('error', function(e) {
                console.error('Upload error:', e);
                alert('Error uploading video');
                document.getElementById('upload-progress').style.display = 'none';
            });
            
            console.log('Sending form data to server...');
            xhr.open('POST', 'save_videos.php', true);
            xhr.send(formData);
        });

        // Reload videos button
        document.getElementById('reload-videos-btn').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            loadVideos().then(() => {
                this.innerHTML = '<i class="fas fa-sync-alt"></i> Reload Videos';
            });
        });

        // View JSON button
        document.getElementById('view-json-btn').addEventListener('click', function() {
            fetch('videos.json')
            .then(response => response.text())
            .then(text => {
                // Create modal to show JSON
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 1000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: #222;
                    padding: 20px;
                    border-radius: 5px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 80vh;
                    overflow: auto;
                `;
                
                const header = document.createElement('div');
                header.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 10px;
                `;
                
                const title = document.createElement('h3');
                title.textContent = 'videos.json Content';
                
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.style.cssText = `
                    background: none;
                    border: none;
                    color: #fff;
                    font-size: 24px;
                    cursor: pointer;
                `;
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                header.appendChild(title);
                header.appendChild(closeBtn);
                
                const pre = document.createElement('pre');
                pre.style.cssText = `
                    background: #333;
                    padding: 10px;
                    border-radius: 5px;
                    color: #fff;
                    overflow: auto;
                    white-space: pre-wrap;
                `;
                
                try {
                    // Try to format JSON nicely
                    const json = JSON.parse(text);
                    pre.textContent = JSON.stringify(json, null, 2);
                } catch (e) {
                    // If not valid JSON, show raw text
                    pre.textContent = text;
                    pre.style.color = '#ff5555';
                    title.textContent = 'videos.json Content (INVALID JSON)';
                }
                
                content.appendChild(header);
                content.appendChild(pre);
                modal.appendChild(content);
                document.body.appendChild(modal);
            })
            .catch(error => {
                alert('Error loading JSON file: ' + error.message);
            });
        });

        // Toggle media upload form
        document.getElementById('upload-media-btn').addEventListener('click', function() {
            const form = document.getElementById('upload-media-form');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                this.innerHTML = '<i class="fas fa-minus"></i> Hide Upload Form';
            } else {
                form.style.display = 'none';
                this.innerHTML = '<i class="fas fa-upload"></i> Upload Media';
            }
        });
        
        // Show selected file name
        document.getElementById('media-file').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'No file selected';
            document.getElementById('media-file-name').textContent = fileName;
        });
        
        // Handle media upload
        document.getElementById('media-upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const mediaType = document.getElementById('media-type').value;
            const mediaFile = document.getElementById('media-file').files[0];
            
            if (!mediaFile) {
                alert('Please select a file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', mediaFile);
            formData.append('type', mediaType);
            
            // Create upload_media.php if it doesn't exist
            const uploadCode = `<?php
            header('Content-Type: application/json');
            header('Access-Control-Allow-Origin: *');
            
            $response = ['success' => false, 'message' => 'Unknown error'];
            
            if (isset($_FILES['file']) && isset($_POST['type'])) {
                $type = $_POST['type'];
                $uploadDir = ($type === 'images') ? 'imagens/' : 'videos/';
                
                // Create directory if it doesn't exist
                if (!file_exists($uploadDir)) {
                    mkdir($uploadDir, 0777, true);
                }
                
                $fileName = basename($_FILES['file']['name']);
                $targetPath = $uploadDir . $fileName;
                
                // Check if file already exists
                if (file_exists($targetPath)) {
                    $fileName = time() . '_' . $fileName;
                    $targetPath = $uploadDir . $fileName;
                }
                
                if (move_uploaded_file($_FILES['file']['tmp_name'], $targetPath)) {
                    $response = [
                        'success' => true,
                        'message' => 'File uploaded successfully',
                        'file' => [
                            'name' => $fileName,
                            'path' => $targetPath,
                            'size' => filesize($targetPath)
                        ]
                    ];
                } else {
                    $response['message'] = 'Failed to upload file';
                }
            } else {
                $response['message'] = 'No file uploaded or invalid type';
            }
            
            echo json_encode($response);
            ?>`;
            
            // Create the upload_media.php file if needed
            fetch('upload_media.php')
                .then(response => {
                    if (!response.ok && response.status === 404) {
                        return fetch('save_config.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'create_file',
                                filename: 'upload_media.php',
                                content: uploadCode
                            })
                        });
                    }
                    return Promise.resolve();
                })
                .catch(() => {
                    console.log('Creating upload_media.php file...');
                });
            
            // Upload the file
            fetch('upload_media.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('File uploaded successfully!');
                    // Reset form
                    document.getElementById('media-upload-form').reset();
                    document.getElementById('media-file-name').textContent = '';
                    // Refresh media list
                    scanMediaFolders();
                    
                    // Update dashboard stats
                    updateDashboardStats();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error uploading file:', error);
                alert('An error occurred while uploading the file. Please try again.');
            });
        });

        // Scan media folders button
        document.getElementById('scan-media-btn').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
            scanMediaFolders().then(() => {
                this.innerHTML = '<i class="fas fa-sync-alt"></i> Scan Media Folders';
            });
        });

        // Function to scan media folders
        function scanMediaFolders() {
            // Create a PHP file to scan directories if it doesn't exist
            const scannerCode = `<?php
            header('Content-Type: application/json');
            header('Access-Control-Allow-Origin: *');
            
            function scanDirectory($dir) {
                $files = [];
                if (is_dir($dir)) {
                    $items = scandir($dir);
                    foreach ($items as $item) {
                        if ($item != "." && $item != "..") {
                            $path = $dir . '/' . $item;
                            if (!is_dir($path)) {
                                $files[] = [
                                    'name' => $item,
                                    'path' => $path,
                                    'size' => filesize($path),
                                    'modified' => date('Y-m-d H:i:s', filemtime($path))
                                ];
                            }
                        }
                    }
                }
                return $files;
            }
            
            $result = [
                'images' => scanDirectory('imagens'),
                'videos' => scanDirectory('videos')
            ];
            
            echo json_encode($result);
            ?>`;
            
            // Create the scanner.php file if needed (only for first time)
            fetch('scan_media.php')
                .then(response => {
                    if (!response.ok && response.status === 404) {
                        // Create the file if it doesn't exist
                        return fetch('save_config.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'create_file',
                                filename: 'scan_media.php',
                                content: scannerCode
                            })
                        });
                    }
                    return Promise.resolve();
                })
                .catch(() => {
                    // Ignore errors, we'll create the file anyway
                    console.log('Creating scan_media.php file...');
                });
            
            // Now scan the media folders
            return fetch('scan_media.php')
                .then(response => response.json())
                .then(data => {
                    // Display images
                    const imagesContainer = document.getElementById('images-container');
                    if (data.images && data.images.length > 0) {
                        imagesContainer.innerHTML = '';
                        data.images.forEach(image => {
                            const imageDiv = document.createElement('div');
                            imageDiv.style.cssText = `
                                background-color: #333;
                                border-radius: 5px;
                                padding: 5px;
                                text-align: center;
                                position: relative;
                            `;
                            
                            // Add delete button
                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            deleteBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background-color: rgba(220, 53, 69, 0.7);
                                color: white;
                                border: none;
                                border-radius: 3px;
                                padding: 3px 6px;
                                cursor: pointer;
                                z-index: 10;
                            `;
                            deleteBtn.onclick = function() {
                                if (confirm(`Are you sure you want to delete ${image.name}?`)) {
                                    deleteMediaFile(image.path);
                                }
                            };
                            
                            // Add copy path button
                            const copyBtn = document.createElement('button');
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                            copyBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                left: 5px;
                                background-color: rgba(0, 123, 255, 0.7);
                                color: white;
                                border: none;
                                border-radius: 3px;
                                padding: 3px 6px;
                                cursor: pointer;
                                z-index: 10;
                            `;
                            copyBtn.onclick = function() {
                                navigator.clipboard.writeText(image.path).then(() => {
                                    alert('Path copied to clipboard!');
                                });
                            };
                            
                            // Add use in form button
                            const useBtn = document.createElement('button');
                            useBtn.innerHTML = '<i class="fas fa-plus-circle"></i>';
                            useBtn.style.cssText = `
                                position: absolute;
                                bottom: 5px;
                                right: 5px;
                                background-color: rgba(40, 167, 69, 0.7);
                                color: white;
                                border: none;
                                border-radius: 3px;
                                padding: 3px 6px;
                                cursor: pointer;
                                z-index: 10;
                            `;
                            useBtn.title = "Use as thumbnail in video form";
                            useBtn.onclick = function() {
                                // Check if video form is open
                                if (document.getElementById('video-form').style.display === 'none') {
                                    // Open the form
                                    document.getElementById('toggle-form-btn').click();
                                    // Switch to the manage videos tab
                                    document.querySelector('[data-tab="manage-videos"]').click();
                                }
                                
                                // Set the thumbnail preview
                                document.getElementById('thumbnail-preview').innerHTML = `
                                    <img src="${image.path}" class="preview-image" alt="Thumbnail Preview">
                                    <input type="hidden" id="existing-thumbnail" value="${image.path}">
                                `;
                                
                                // Scroll to form
                                document.getElementById('video-form').scrollIntoView({ behavior: 'smooth' });
                            };
                            
                            imageDiv.innerHTML = `
                                <img src="${image.path}" alt="${image.name}" style="max-width: 100%; height: 100px; object-fit: cover; border-radius: 3px;">
                                <div style="margin-top: 5px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${image.name}</div>
                                <div style="font-size: 10px; color: #aaa;">${Math.round(image.size / 1024)} KB</div>
                            `;
                            
                            imageDiv.appendChild(deleteBtn);
                            imageDiv.appendChild(copyBtn);
                            imageDiv.appendChild(useBtn);
                            imagesContainer.appendChild(imageDiv);
                        });
                    } else {
                        imagesContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #ff5555;">No images found in the imagens/ folder</div>';
                    }
                    
                    // Display videos
                    const videosContainer = document.getElementById('videos-container');
                    if (data.videos && data.videos.length > 0) {
                        videosContainer.innerHTML = '';
                        data.videos.forEach(video => {
                            const videoDiv = document.createElement('div');
                            videoDiv.style.cssText = `
                                background-color: #333;
                                border-radius: 5px;
                                padding: 5px;
                                text-align: center;
                                position: relative;
                            `;
                            
                            // Add delete button
                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            deleteBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background-color: rgba(220, 53, 69, 0.7);
                                color: white;
                                border: none;
                                border-radius: 3px;
                                padding: 3px 6px;
                                cursor: pointer;
                                z-index: 10;
                            `;
                            deleteBtn.onclick = function() {
                                if (confirm(`Are you sure you want to delete ${video.name}?`)) {
                                    deleteMediaFile(video.path);
                                }
                            };
                            
                            // Add copy path button
                            const copyBtn = document.createElement('button');
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                            copyBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                left: 5px;
                                background-color: rgba(0, 123, 255, 0.7);
                                color: white;
                                border: none;
                                border-radius: 3px;
                                padding: 3px 6px;
                                cursor: pointer;
                                z-index: 10;
                            `;
                            copyBtn.onclick = function() {
                                navigator.clipboard.writeText(video.path).then(() => {
                                    alert('Path copied to clipboard!');
                                });
                            };
                            
                            // Add use in form button
                            const useBtn = document.createElement('button');
                            useBtn.innerHTML = '<i class="fas fa-plus-circle"></i>';
                            useBtn.style.cssText = `
                                position: absolute;
                                bottom: 5px;
                                right: 5px;
                                background-color: rgba(40, 167, 69, 0.7);
                                color: white;
                                border: none;
                                border-radius: 3px;
                                padding: 3px 6px;
                                cursor: pointer;
                                z-index: 10;
                            `;
                            useBtn.title = "Use as video link";
                            useBtn.onclick = function() {
                                // Check if video form is open
                                if (document.getElementById('video-form').style.display === 'none') {
                                    // Open the form
                                    document.getElementById('toggle-form-btn').click();
                                    // Switch to the manage videos tab
                                    document.querySelector('[data-tab="manage-videos"]').click();
                                }
                                
                                // Set the video link
                                document.getElementById('video-link').value = video.path;
                                
                                // Scroll to form
                                document.getElementById('video-form').scrollIntoView({ behavior: 'smooth' });
                            };
                            
                            videoDiv.innerHTML = `
                                <video style="max-width: 100%; height: 120px; object-fit: cover; border-radius: 3px;" controls>
                                    <source src="${video.path}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <div style="margin-top: 5px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${video.name}</div>
                                <div style="font-size: 10px; color: #aaa;">${Math.round(video.size / 1024)} KB</div>
                            `;
                            
                            videoDiv.appendChild(deleteBtn);
                            videoDiv.appendChild(copyBtn);
                            videoDiv.appendChild(useBtn);
                            videosContainer.appendChild(videoDiv);
                        });
                    } else {
                        videosContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #ff5555;">No videos found in the videos/ folder</div>';
                    }
                    
                    // Update dashboard stats after scanning
                    updateDashboardStats();
                    
                    return data;
                })
                .catch(error => {
                    console.error('Error scanning media folders:', error);
                    document.getElementById('images-container').innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #ff5555;">Error scanning images: ${error.message}</div>`;
                    document.getElementById('videos-container').innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #ff5555;">Error scanning videos: ${error.message}</div>`;
                    throw error;
                });
        }
        
        // Function to delete media file
        function deleteMediaFile(filePath) {
            // Create delete_media.php if it doesn't exist
            const deleteCode = `<?php
            header('Content-Type: application/json');
            header('Access-Control-Allow-Origin: *');
            
            $response = ['success' => false, 'message' => 'Unknown error'];
            
            $input = json_decode(file_get_contents('php://input'), true);
            
            if (isset($input['file'])) {
                $file = $input['file'];
                
                // Security check: make sure file is in imagens/ or videos/ directory
                if (strpos($file, 'imagens/') === 0 || strpos($file, 'videos/') === 0) {
                    if (file_exists($file) && unlink($file)) {
                        $response = [
                            'success' => true,
                            'message' => 'File deleted successfully'
                        ];
                    } else {
                        $response['message'] = 'Failed to delete file or file does not exist';
                    }
                } else {
                    $response['message'] = 'Invalid file path';
                }
            } else {
                $response['message'] = 'No file specified';
            }
            
            echo json_encode($response);
            ?>`;
            
            // Create the delete_media.php file if needed
            fetch('delete_media.php')
                .then(response => {
                    if (!response.ok && response.status === 404) {
                        return fetch('save_config.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'create_file',
                                filename: 'delete_media.php',
                                content: deleteCode
                            })
                        });
                    }
                    return Promise.resolve();
                })
                .catch(() => {
                    console.log('Creating delete_media.php file...');
                });
            
            // Delete the file
            fetch('delete_media.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file: filePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('File deleted successfully!');
                    // Refresh media list
                    scanMediaFolders();
                    
                    // Update dashboard stats
                    updateDashboardStats();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting file:', error);
                alert('An error occurred while deleting the file. Please try again.');
            });
        }
        
        // Load media files when tab is clicked
        document.querySelector('[data-tab="media-files"]').addEventListener('click', function() {
            scanMediaFolders();
        });

        // Load videos from server
        function loadVideos() {
            return fetch('videos.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load videos. Status: ' + response.status);
                }
                return response.json();
            })
            .then(videos => {
                console.log('Videos loaded:', videos.length, 'items');
                const videosList = document.getElementById('videos-list');
                videosList.innerHTML = '';
                
                if (videos.length === 0) {
                    videosList.innerHTML = '<tr><td colspan="6" style="text-align: center;">No videos found. Add your first video!</td></tr>';
                    updateDashboardStats();
                    return videos;
                }
                
                // Sort videos by created_at in descending order (newest first)
                videos.sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                videos.forEach(video => {
                    const row = document.createElement('tr');
                    
                    // Create thumbnail cell
                    const thumbnailCell = document.createElement('td');
                    if (video.image) {
                        const img = document.createElement('img');
                        img.src = `get_video.php?path=${encodeURIComponent(video.image)}`;
                        img.style.width = '100px';
                        img.style.height = '60px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '4px';
                        thumbnailCell.appendChild(img);
                    }
                    
                    row.innerHTML = `
                        <td>${video.title || 'Untitled'}</td>
                        <td>$${video.price || '0'}</td>
                        <td>${video.duration || '00:00'}</td>
                        <td><span class="status-badge ${video.status === 'Active' ? 'status-active' : 'status-inactive'}">${video.status || 'Inactive'}</span></td>
                        <td>
                            <button class="action-btn view-btn" data-id="${video.id}" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit-btn" data-id="${video.id}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" data-id="${video.id}" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    
                    // Insert thumbnail cell at the beginning
                    row.insertBefore(thumbnailCell, row.firstChild);
                    
                    videosList.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.getAttribute('data-id');
                        editVideo(videoId, videos);
                    });
                });
                
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.getAttribute('data-id');
                        viewVideoDetails(videoId, videos);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.getAttribute('data-id');
                        showDeleteModal(videoId);
                    });
                });
                
                return videos;
            })
            .catch(error => {
                console.error('Error loading videos:', error);
                document.getElementById('videos-list').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #ff5555;">
                            Error loading videos: ${error.message}. 
                            <br>Make sure videos.json exists and is valid.
                        </td>
                    </tr>`;
                throw error;
            });
        }

        // Edit video function
        function editVideo(id, videos) {
            console.log('Editing video with ID:', id);
            const video = videos.find(v => v.id == id);
            if (video) {
                console.log('Found video data:', video);
                const modal = document.getElementById('video-upload-modal');
                document.getElementById('modal-form-title').textContent = 'Edit Video';
                
                // Clear form first
                document.getElementById('upload-form').reset();
                
                // Fill form with video data
                document.getElementById('video-id').value = id;
                console.log('Set video-id field to:', id);
                
                document.getElementById('title').value = video.title || '';
                document.getElementById('price').value = video.price || 0;
                document.getElementById('description').value = video.description || '';
                document.getElementById('duration').value = video.duration || '';
                document.getElementById('status').value = video.status || 'Active';
                document.getElementById('video-link').value = video.videoLink || '';
                
                // Show thumbnail preview if available
                if (video.image) {
                    console.log('Setting thumbnail preview:', video.image);
                    document.getElementById('thumbnail-preview').innerHTML = `
                        <img src="get_video.php?path=${encodeURIComponent(video.image)}" class="preview-image" alt="Thumbnail Preview">
                        <input type="hidden" name="existing-image" value="${video.image}">
                    `;
                } else {
                    document.getElementById('thumbnail-preview').innerHTML = '';
                }
                
                // Show video preview if available
                if (video.videoUrl) {
                    console.log('Setting video preview:', video.videoUrl);
                    document.getElementById('video-preview').innerHTML = `
                        <video width="200" controls>
                            <source src="get_video.php?path=${encodeURIComponent(video.videoUrl)}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <input type="hidden" name="existing-video" value="${video.videoUrl}">
                    `;
                } else {
                    document.getElementById('video-preview').innerHTML = '';
                }
                
                // For debugging - check form values before displaying
                console.log('Form values before showing modal:');
                const formData = new FormData(document.getElementById('upload-form'));
                for (const [key, value] of formData.entries()) {
                    console.log(`${key}: ${value instanceof File ? value.name : value}`);
                }
                
                modal.style.display = 'flex';
            } else {
                console.error('Video not found with ID:', id);
                alert('Error: Video not found');
            }
        }

        // Delete modal functionality
        function showDeleteModal(id) {
            const modal = document.getElementById('delete-modal');
            modal.style.display = 'flex';
            
            // Set up confirm delete button
            document.getElementById('confirm-delete').onclick = function() {
                deleteVideo(id);
                modal.style.display = 'none';
            };
            
            // Set up close button
            document.querySelector('.close-modal').onclick = function() {
                modal.style.display = 'none';
            };
            
            // Close modal when clicking cancel
            document.querySelector('.modal-footer .btn:first-child').onclick = function() {
                modal.style.display = 'none';
            };
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        // Delete video function
        function deleteVideo(id) {
            console.log('Attempting to delete video:', id);
            
            // Create confirmation before deleting
            fetch('save_videos.php', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id
                })
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                if (data.success) {
                    console.log('Video deleted successfully:', id);
                    alert('Video deleted successfully!');
                    
                    // Force browser to reload the JSON file by adding cache buster
                    const cacheBuster = new Date().getTime();
                    fetch('videos.json?_=' + cacheBuster, { 
                        cache: 'no-store',
                        headers: { 'Cache-Control': 'no-cache' }
                    })
                    .then(() => {
                        console.log('Reloading videos...');
                        return loadVideos();
                    })
                    .then(() => {
                        console.log('Updating dashboard stats...');
                    updateDashboardStats();
                    })
                    .catch(err => {
                        console.error('Error reloading after deletion:', err);
                    });
                } else {
                    console.error('Error deleting video:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during deletion. Please try again.');
            });
        }

        // Save site configuration
        document.getElementById('save-config').addEventListener('click', function() {
            const siteTitle = document.getElementById('site-title').value;
            const adminPassword = document.getElementById('admin-password').value;
            const paypalClientId = document.getElementById('paypal-client-id').value;
            const telegramLink = document.getElementById('telegram-link').value;
            const telegramUsername = document.getElementById('telegram-username').value;
            
            fetch('save_config.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    siteTitle: siteTitle,
                    adminPassword: adminPassword,
                    paypalClientId: paypalClientId,
                    telegramLink: telegramLink,
                    telegramUsername: telegramUsername
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    if (adminPassword) {
                        alert('Password updated. You will be logged out.');
                        localStorage.removeItem('adminLoggedIn');
                        window.location.reload();
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });

        // View video details function
        function viewVideoDetails(id, videos) {
            const video = videos.find(v => v.id == id);
            if (video) {
                const modal = document.getElementById('video-details-modal');
                const content = document.getElementById('video-details-content');
                
                // Store the ID for the edit button to use
                modal.dataset.videoId = id;
                console.log('Stored video ID in modal dataset:', id);
                
                // Format content
                let detailsHTML = `
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 0 0 200px;">
                            ${video.image ? `<img src="get_video.php?path=${encodeURIComponent(video.image)}" alt="${video.title}" style="width: 100%; border-radius: 5px;">` : '<div style="width: 100%; height: 150px; background-color: #444; display: flex; align-items: center; justify-content: center; border-radius: 5px;"><i class="fas fa-image" style="font-size: 48px; color: #666;"></i></div>'}
                        </div>
                        <div style="flex: 1;">
                            <h2 style="margin-top: 0;">${video.title || 'Untitled'}</h2>
                            <p><strong>Price:</strong> $${video.price || '0'}</p>
                            <p><strong>Duration:</strong> ${video.duration || 'Not specified'}</p>
                            <p><strong>Status:</strong> <span class="status-badge ${video.status === 'Active' ? 'status-active' : 'status-inactive'}">${video.status || 'Inactive'}</span></p>
                            <p><strong>Created:</strong> ${video.created_at || 'Unknown'}</p>
                            <p><strong>Last Updated:</strong> ${video.updated_at || 'Unknown'}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>Description</h3>
                        <div style="background-color: #333; padding: 15px; border-radius: 5px;">${video.description || 'No description available'}</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>Video Link</h3>
                        <div style="background-color: #333; padding: 15px; border-radius: 5px; word-break: break-all;">
                            ${video.videoLink ? `<a href="${video.videoLink}" target="_blank" style="color: #ff0000;">${video.videoLink}</a>` : 'No video link available'}
                        </div>
                    </div>
                `;
                
                // Add preview video if available
                if (video.videoUrl) {
                    detailsHTML += `
                        <div>
                            <h3>Preview</h3>
                            <video width="100%" controls style="border-radius: 5px;" onloadedmetadata="this.parentElement.querySelector('.duration').textContent = 'Duration: ' + formatDuration(this.duration)">
                                <source src="get_video.php?path=${encodeURIComponent(video.videoUrl)}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <p class="duration" style="margin-top: 10px; color: #aaa;">Loading duration...</p>
                        </div>
                    `;
                }
                
                content.innerHTML = detailsHTML;
                
                // Set up edit button
                document.getElementById('edit-from-details').onclick = function() {
                    const videoId = modal.dataset.videoId;
                    console.log('Edit button clicked with ID:', videoId);
                    modal.style.display = 'none';
                    editVideo(videoId, videos);
                };
                
                // Show modal
                modal.style.display = 'flex';
                
                // Set up close buttons
                modal.querySelectorAll('.close-modal, .close-modal-btn').forEach(btn => {
                    btn.onclick = function() {
                        modal.style.display = 'none';
                    };
                });
                
                // Close modal when clicking outside
                window.onclick = function(event) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                };
            }
        }

        // Add close modal functionality
        document.querySelectorAll('.close-modal, .close-modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('video-upload-modal').style.display = 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('video-upload-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Add this function after the existing JavaScript functions
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html> 